
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Devise + OmniAuth + Facebook API Hacks - A Hackerpress Blog</title>
  <meta name="author" content="Joe Johnston">

  
  <meta name="description" content="While using Devise + OmniAuth for a new Rails 3 project, I got really curious about how to reuse OmniAuth’s strategy classes to fetch additional API &hellip;">
  
  <meta name="apple-mobile-web-app-title" content="A Hackerpress Blog">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="shortcut icon" href="/images/logos/favicon.ico">
  <link rel="apple-touch-icon" href="/images/logos/logo_57x57.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/logos/logo_72x72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/logos/logo_114x114.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/logos/logo_144x144.png">

  <!-- Prefetch DNS for external assets -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//www.google-analytics.com">

  
  <link rel="canonical" href="http://www.10hacks.com/rails3/ruby/2011/01/13/devise-omniauth-facebook-api-hacks">
  <link href="/atom.xml" rel="alternate" title="A Hackerpress Blog" type="application/atom+xml">

  <link rel="stylesheet" href="/assets/app-49f1e024af8dc01e63da97811f24a41f.css">

  

</head>

<body   >
  <!-- <header role="banner"></header> -->
  <nav role="navigation" class="container">
  <!--
  
  <form action="http://google.com/search" method="get">
    <fieldset role="search">
      <input type="hidden" name="q" value="site:www.10hacks.com" />
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    </fieldset>
  </form>
   -->

  <div class="navbar">
    <div class="navbar-inner">
      <a class="brand" href="" title="A Hackerpress Blog">A Hackerpress Blog</a>
      <ul class="nav">
        
        
          
        
          
            
          
        
          
            
          
        
          
        
          
            
          
        
          
            
          
        
        
      </ul>
      <div class="btn-group pull-right">
        <a class="btn btn-primary" href="#"><i class="fui-twitter"></i></a>
        <a class="btn btn-primary" href="#contact-modal" data-toggle="modal" data-target="#contactModal"><i class="fui-mail"></i></a>
        <a class="btn btn-primary" href="#"><i class="fui-github"></i></a>
        <a class="btn btn-primary" href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS"><i class="fui-rss"></i></a>
      </div>
    </div>
  </div>
</nav>

  <section class="page-header">
  <div class="container">
    Devise + OmniAuth + Facebook API Hacks 
  </div>
</section>


  <div class="container">
    <div class="row-fluid">
      <div id="content" class="span12">
        <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Devise + OmniAuth + Facebook API Hacks</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-13T19:12:16-08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>While using <a href="https://github.com/plataformatec/devise">Devise</a> + <a href="https://github.com/intridea/omniauth">OmniAuth</a> for a new Rails 3 project, I got really curious about how to reuse OmniAuth’s strategy classes to fetch additional API data after a user has authenticated.</p>

<p>A lot of people probably use libraries like <a href="https://github.com/nov/fb_graph">FbGraph</a> along with OmniAuth, but I wanted something extremely lightweight without duplicating code already in OmniAuth.</p>

<p>I mostly followed Ryan Bates’ <a href="http://railscasts.com/episodes/235-omniauth-part-1">railscasts</a> on setting up Devise + OmniAuth.</p>

<p>If you open the oa-oauth gem, you’ll see a lib/omniauth/strategies folder filled with all sorts of OAuth2 providers like Facebook, Twitter, and LinkedIn. Each of these provider classes has most if not everything needed to make direct API calls once an OAuth2 access_token is obtained.</p>

<p>The basic idea is to store the access_token during an OAuth2 login process (Ryan covers this in his railscast) and later on use the token to fetch more data. To do this, you use the access_token to instantiate an OAuth2::AccessToken along with a Facebook specific OAuth2::Client. The Facebook client really just sets the site URL variable so the AccessToken knows where to send requests. It seems simple enough to just use OmniAuth’s strategy classes for the OAuth2::Client. Then I don’t have to maintain provider specific code myself.</p>

<p>I dug around in the Devise, OmniAuth, and OAuth2 code for hours.  Long story short, the simplest solution is to just write your own provider client class instead of trying to reuse OmniAuth’s. Bummer. But way easier in the end. OmniAuth is a rack application designed for authentication only. It’s just too convoluted to try to reuse its strategy classes for additional API calls.</p>

<p>Here’s the simple solution I ended up writing…</p>

<p>Create lib/facebook.rb in your rails app</p>

<p>[code language=”ruby”]
module OAuth2
  module Clients
    class Facebook &lt; Client
      def initialize(client_id, client_secret, opts = {})
        opts[:site] = ‘https://graph.facebook.com/’
        super(client_id, client_secret, opts)
      end
    end
  end
end
[/code]</p>

<p>Now you can use the Facebook client along with a user specific access_token (stored in a database during the OmniAuth login process) to fetch additional API data.</p>

<p>[code language=”ruby”]
require ‘facebook’
client = OAuth2::Clients::Facebook.new(‘’, ‘’)
token = OAuth2::AccessToken.new(client, access_token)
token.get(‘/me/friends’)
[/code]</p>

<p>Note that you don’t need to set the client_id, and client_secret when creating a new Facebook object. The id and secret are only needed to initially obtain the access_token which you already have.</p>

<p>On a side note, it’s good to keep in mind that every additional OmniAuth provider creates a new rack application which gets called on every request. Hopefully this will not be the case in future versions so that an arbitrary number of providers can be supported without any performance concerns.</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">joe</span></span>

      








  


<time datetime="2011-01-13T19:12:16-08:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    rails3ruby
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.10hacks.com/rails3/ruby/2011/01/13/devise-omniauth-facebook-api-hacks/" data-via="" data-counturl="http://www.10hacks.com/rails3/ruby/2011/01/13/devise-omniauth-facebook-api-hacks/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/social%20web/2010/09/23/fixing-online-groups/" title="Previous Post: Fixing Online Groups">&laquo; Fixing Online Groups</a>
      
      
        <a class="basic-alignment right" href="/hacks/rails3/2011/01/17/rails-3-sti/" title="Next Post: Rails 3 + STI: Making Associations Work Properly">Rails 3 + STI: Making Associations Work Properly &raquo;</a>
      
    </p>
  </footer>
</article>
<section>
  


  Included file 'comments/disqus' not found in _includes directory



</section>
</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/ignore-jquery-jsonp-callbacks-in-mocha">Ignore jQuery JSONP Callbacks in Mocha</a>
      </li>
    
      <li class="post">
        <a href="/linux-default-gateway-route">Linux Default Gateway Route</a>
      </li>
    
      <li class="post">
        <a href="/rails3/ruby/2012/04/11/chaining-bundle-gemfiles/">Chaining Bundle Gemfiles</a>
      </li>
    
      <li class="post">
        <a href="/save-only-changed-attributes-in-backbone-js">Save Only Changed Attributes in Backbone.js</a>
      </li>
    
      <li class="post">
        <a href="/ruby/testing/2012/03/15/rspec-capybara-devise-login-tests/">RSpec + Capybara + Devise Login Tests</a>
      </li>
    
  </ul>
</section>





  
</aside>


      </div>
    </div>
  </div>

  <div id="contactModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="contactModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="contactModalLabel">Modal header</h3>
  </div>
  <div class="modal-body">
    <p>One fine body…</p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary">Save changes</button>
  </div>
</div>

  <footer role="contentinfo">
</footer>

  <script src="/assets/app-0c2275567ca821cfac79954c41ff6570.js"></script>
</body>
</html>
