
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Devise + OmniAuth + Facebook API Hacks - 10 Hacks</title>
  <meta name="author" content="Joe Johnston">

  
  <meta name="description" content="While using Devise + OmniAuth for a new Rails 3 project, I got really curious about how to reuse OmniAuth’s strategy classes to fetch additional API &hellip;">
  
  <meta name="apple-mobile-web-app-title" content="10 Hacks">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="shortcut icon" href="/images/logos/favicon.ico">
  <link rel="apple-touch-icon" href="/images/logos/logo_57x57.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/logos/logo_72x72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/logos/logo_114x114.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/logos/logo_144x144.png">

  <!-- Prefetch DNS for external assets -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//www.google-analytics.com">

  
  <link rel="canonical" href="http://www.10hacks.com/devise-omniauth-facebook-api-hacks">
  <link href="/atom.xml" rel="alternate" title="10 Hacks" type="application/atom+xml">

  <link rel="stylesheet" href="/assets/app-4b572b6a4bef935693e53b251f96a0cd.css">
  <script src="/assets/head-d92d16045604cdb37199b5ea0e7c26f5.js"></script>
</head>

<body   >
  <nav role="navigation" class="container">
  <!--
  
  <form action="http://google.com/search" method="get">
    <fieldset role="search">
      <input type="hidden" name="q" value="site:www.10hacks.com" />
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    </fieldset>
  </form>
   -->

  <div class="navbar">
    <div class="navbar-inner">
      <a class="brand" href="/" title="10 Hacks">
        <img src="/images/logos/logo.svg">
        10 Hacks
      </a>
      <ul class="nav">
        
        
          
        
          
            
          
        
          
            
          
        
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
        
      </ul>
      <div class="btn-group pull-right">
        <a class="btn btn-primary" href="https://twitter.com/joejohnston"><i class="fui-twitter"></i></a>
        <a class="btn btn-primary" href="#contact-modal" data-toggle="modal" data-target="#contactModal"><i class="fui-mail"></i></a>
        <a class="btn btn-primary" href="https://github.com/simple10"><i class="fui-github"></i></a>
        <a class="btn btn-primary" href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS"><i class="fui-rss"></i></a>
      </div>
    </div>
  </div>
</nav>

  

  <div class="container">
    <div class="row-fluid">
      <div id="content" class="span12">
        <article role="article">
  
  <header>
    
      <h1 class="entry-title">Devise + OmniAuth + Facebook API Hacks</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-14T03:12:16Z" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>While using <a href="https://github.com/plataformatec/devise">Devise</a> + <a href="https://github.com/intridea/omniauth">OmniAuth</a> for a new Rails 3 project, I got really curious about how to reuse OmniAuth’s strategy classes to fetch additional API data after a user has authenticated.</p>

<p>A lot of people probably use libraries like <a href="https://github.com/nov/fb_graph">FbGraph</a> along with OmniAuth, but I wanted something extremely lightweight without duplicating code already in OmniAuth.</p>

<p>I mostly followed Ryan Bates’ <a href="http://railscasts.com/episodes/235-omniauth-part-1">railscasts</a> on setting up Devise + OmniAuth.</p>

<p>If you open the oa-oauth gem, you’ll see a <code>lib/omniauth/strategies</code> folder filled with all sorts of OAuth2 providers like Facebook, Twitter, and LinkedIn. Each of these provider classes has most if not everything needed to make direct API calls once an OAuth2 access_token is obtained.</p>

<p>The basic idea is to store the access_token during an OAuth2 login process (Ryan covers this in his railscast) and later on use the token to fetch more data. To do this, you use the access_token to instantiate an OAuth2::AccessToken along with a Facebook specific <code>OAuth2::Client</code>. The Facebook client really just sets the site URL variable so the AccessToken knows where to send requests. It seems simple enough to just use OmniAuth’s strategy classes for the <code>OAuth2::Client</code>. Then I don’t have to maintain provider specific code myself.</p>

<p>I dug around in the Devise, OmniAuth, and OAuth2 code for hours.  Long story short, the simplest solution is to just write your own provider client class instead of trying to reuse OmniAuth’s. Bummer. But way easier in the end. OmniAuth is a rack application designed for authentication only. It’s just too convoluted to try to reuse its strategy classes for additional API calls.</p>

<p>Here’s the simple solution I ended up writing…</p>

<p>Create lib/facebook.rb in your rails app</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">OAuth2</span>
</span><span class="line">  <span class="k">module</span> <span class="nn">Clients</span>
</span><span class="line">    <span class="k">class</span> <span class="nc">Facebook</span> <span class="o">&lt;</span> <span class="no">Client</span>
</span><span class="line">      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class="line">        <span class="n">opts</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;https://graph.facebook.com/&#39;</span>
</span><span class="line">        <span class="k">super</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now you can use the Facebook client along with a user specific access_token (stored in a database during the OmniAuth login process) to fetch additional API data.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">&#39;facebook&#39;</span>
</span><span class="line"><span class="n">client</span> <span class="o">=</span> <span class="ss">OAuth2</span><span class="p">:</span><span class="ss">:Clients</span><span class="o">::</span><span class="no">Facebook</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">token</span> <span class="o">=</span> <span class="ss">OAuth2</span><span class="p">:</span><span class="ss">:AccessToken</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">access_token</span><span class="p">)</span>
</span><span class="line"><span class="n">token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/me/friends&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note that you don’t need to set the client_id, and client_secret when creating a new Facebook object. The id and secret are only needed to initially obtain the access_token which you already have.</p>

<p>On a side note, it’s good to keep in mind that every additional OmniAuth provider creates a new rack application which gets called on every request. Hopefully this will not be the case in future versions so that an arbitrary number of providers can be supported without any performance concerns.</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">joe</span></span>

      








  


<time datetime="2011-01-14T03:12:16Z" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/category/code/'>code</a>
  
</span>


    </p>

    
      <div class="sharing">
  
    <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.10hacks.com/devise-omniauth-facebook-api-hacks" data-via="joejohnston" data-counturl="http://www.10hacks.com/devise-omniauth-facebook-api-hacks" >Tweet</a>
  
  
    <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-width="90" data-layout="button_count" data-send="false" data-show-faces="false"></div>
  
</div>

    

    <p class="meta">
      
        <a href="/ideas/2010/09/23/fixing-online-groups/" title="Previous Post: Fixing Online Groups">&laquo; Fixing Online Groups</a>
      
      
        <a href="/rails-3-sti" title="Next Post: Rails 3 + STI: Making Associations Work Properly">Rails 3 + STI: Making Associations Work Properly &raquo;</a>
      
    </p>
  </footer>
</article>

<section>
  


  
<div id="disqus_thread" aria-live="polite"></div>
<script type="text/javascript">
      var disqus_shortname = '10hacks';
      
        // var disqus_developer = 1;
        
          
        
        var disqus_identifier = '186 http://www.simple10.com/?p=186';
        var disqus_url = 'http://www.10hacks.com/devise-omniauth-facebook-api-hacks';
        var disqus_title = 'Devise + OmniAuth + Facebook API Hacks';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</section>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id; js.async = true;
    js.src = "//connect.facebook.net/en_US/all.js#appId=&xfbml=1";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>




      </div>
    </div>
  </div>

  <div id="contactModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="contactModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="contactModalLabel">Contact Me</h3>
  </div>
  <div class="modal-body">
    <p>Email: <a href="mailto:joe@10hacks.com?subject=[10Hacks] Contact Me" target="_blank">joe@10hacks.com</a></p>
    <p><small>Please include [10Hacks] in the subject line. Thanks!</small></p>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" data-dismiss="modal">OK</button>
  </div>
</div>

  <footer role="contentinfo">
</footer>

  <script src="/assets/app-f7ffe072f168a685fc7907507b69cd57.js"></script>
  

</body>
</html>
