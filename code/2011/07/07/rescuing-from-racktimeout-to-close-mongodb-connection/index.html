
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Rescuing from Rack::Timeout to Close MongoDB Connection - 10 Hacks</title>
  <meta name="author" content="Joe Johnston">

  
  <meta name="description" content="I’m using Rack::Timeout on Heroku to kill requests before Heroku’s 30 second limit is reached. This helps applications play nice with cloud &hellip;">
  
  <meta name="apple-mobile-web-app-title" content="10 Hacks">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="shortcut icon" href="/images/logos/favicon.ico">
  <link rel="apple-touch-icon" href="/images/logos/logo_57x57.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/logos/logo_72x72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/logos/logo_114x114.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/logos/logo_144x144.png">

  <!-- Prefetch DNS for external assets -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//www.google-analytics.com">

  
  <link rel="canonical" href="http://www.10hacks.com/code/2011/07/07/rescuing-from-racktimeout-to-close-mongodb-connection">
  <link href="/atom.xml" rel="alternate" title="10 Hacks" type="application/atom+xml">

  <link rel="stylesheet" href="/assets/app-dfb7b472daf9d87024999b78341fc0ad.css">

  

</head>

<body   >
  <!-- <header role="banner"></header> -->
  <nav role="navigation" class="container">
  <!--
  
  <form action="http://google.com/search" method="get">
    <fieldset role="search">
      <input type="hidden" name="q" value="site:www.10hacks.com" />
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    </fieldset>
  </form>
   -->

  <div class="navbar">
    <div class="navbar-inner">
      <a class="brand" href="/" title="10 Hacks">10 Hacks</a>
      <ul class="nav">
        
        
          
        
          
            
          
        
          
            
          
        
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
        
      </ul>
      <div class="btn-group pull-right">
        <a class="btn btn-primary" href="#"><i class="fui-twitter"></i></a>
        <a class="btn btn-primary" href="#contact-modal" data-toggle="modal" data-target="#contactModal"><i class="fui-mail"></i></a>
        <a class="btn btn-primary" href="#"><i class="fui-github"></i></a>
        <a class="btn btn-primary" href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS"><i class="fui-rss"></i></a>
      </div>
    </div>
  </div>
</nav>

  <section class="page-header">
  <div class="container">
    
      Rescuing from Rack::Timeout to Close MongoDB Connection
    
    
  </div>
</section>


  <div class="container">
    <div class="row-fluid">
      <div id="content" class="span12">
        <article role="article">
  
  <header>
    
      <h1 class="entry-title">Rescuing From Rack::Timeout to Close MongoDB Connection</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-07T15:56:09-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I’m using Rack::Timeout on Heroku to kill requests before Heroku’s 30 second limit is reached. This helps applications play nice with cloud infrastructure but can cause some unexpected bugs with <a href="https://jira.mongodb.org/browse/RUBY-231?focusedCommentId=26045&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_26045">MongoDB connections being reused</a> by the next request.</p>

<p>The errors showed up as…</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">Mongo::ConnectionFailure: Expected response 372 but got 371
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Mongo ruby driver &gt;=1.3 catches the reused request and raises an error, but this still means the first and next requests both returned errors. It’s much better to catch the initial timeout and close the connection.</p>

<p>It seems like rescue_from Timeout::Error in ApplicationController should work, but for some reason the exception passed in is a Class and not Timeout::Error – most likely due to Rack::Timeout wrapping the entire app.</p>

<p>I <a href="http://www.google.com/search?sourceid=chrome&amp;ie=UTF-8&amp;q=rescue_from+timeout+error">googled around</a> and couldn’t find a more elegant solution, but the below snippet in ApplicationController does the trick.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># note: can not rescue from Timeout::Error directly because a timeout from Rack::Timeout ends up passing in Class as the exception</span>
</span><span class="line"><span class="n">rescue_from</span> <span class="no">Exception</span> <span class="k">do</span> <span class="o">|</span><span class="n">exception</span><span class="o">|</span>
</span><span class="line">  <span class="c1"># catch Timeout::Error or message from Rack::Timeout</span>
</span><span class="line">  <span class="k">if</span> <span class="n">exception</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="ss">Timeout</span><span class="p">:</span><span class="ss">:Error</span><span class="p">)</span> <span class="o">||</span> <span class="sr">/execution expired/</span> <span class="o">=~</span> <span class="n">exception</span><span class="o">.</span><span class="n">message</span>
</span><span class="line">    <span class="c1"># prevent subsequent requests from reusing this mongo connection</span>
</span><span class="line">    <span class="no">Mongoid</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="k">raise</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As a side note, Heroku’s new cedar stack does not have the 30 second limit if you’re streaming data – Rails 3.1 supports streaming.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">joe</span></span>

      








  


<time datetime="2011-07-07T15:56:09-07:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/category/code/'>code</a>
  
</span>


    </p>

    
      <div class="sharing">
  
    <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.10hacks.com/code/2011/07/07/rescuing-from-racktimeout-to-close-mongodb-connection/" data-via="" data-counturl="http://www.10hacks.com/code/2011/07/07/rescuing-from-racktimeout-to-close-mongodb-connection/" >Tweet</a>
  
  
    <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-width="90" data-layout="button_count" data-send="false" data-show-faces="false"></div>
  
</div>

    

    <p class="meta">
      
        <a href="/code/2011/02/17/validating-a-single-attribute-in-rails-activerecord/" title="Previous Post: Validating a Single Attribute in Rails ActiveRecord">&laquo; Validating a Single Attribute in Rails ActiveRecord</a>
      
      
        <a href="/resque-admin-in-rails-3-routes-with-cancan" title="Next Post: Resque Admin in Rails 3 Routes with CanCan">Resque Admin in Rails 3 Routes with CanCan &raquo;</a>
      
    </p>
  </footer>
</article>

<section>
  


  
<div id="disqus_thread" aria-live="polite"></div>
<script type="text/javascript">
      var disqus_shortname = '10hacks';
      
        // var disqus_developer = 1;
        
        var disqus_url = 'http://www.10hacks.com/code/2011/07/07/rescuing-from-racktimeout-to-close-mongodb-connection/';
        var disqus_title = 'Rescuing from Rack::Timeout to Close MongoDB Connection';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</section>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id; js.async = true;
    js.src = "//connect.facebook.net/en_US/all.js#appId=&xfbml=1";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>




      </div>
    </div>
  </div>

  <div id="contactModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="contactModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="contactModalLabel">Modal header</h3>
  </div>
  <div class="modal-body">
    <p>One fine body…</p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary">Save changes</button>
  </div>
</div>

  <footer role="contentinfo">
</footer>

  <script src="/assets/app-0c2275567ca821cfac79954c41ff6570.js"></script>
</body>
</html>
